<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="F&O Scanner">
    <meta name="theme-color" content="#0a0e27">
    <title>NSE F&O Scanner - Live Angel SmartAPI</title>
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2300ff88' width='100' height='100'/><text y='75' font-size='70' fill='%230a0e27'>üìä</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif; background: #0a0e27; color: #e1e4e8; overflow-x: hidden; -webkit-font-smoothing: antialiased; padding-bottom: env(safe-area-inset-bottom); }
        .mobile-header { position: sticky; top: 0; background: linear-gradient(135deg, #1a1f3a 0%, #2d3561 100%); padding: max(env(safe-area-inset-top), 15px) 15px 15px 15px; z-index: 1000; box-shadow: 0 2px 20px rgba(0,0,0,0.3); }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .app-title { font-size: 20px; font-weight: 700; color: #00ff88; display: flex; align-items: center; gap: 8px; }
        .status-badge { display: flex; gap: 8px; align-items: center; }
        .badge { padding: 5px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .badge-live { background: rgba(0,255,136,0.2); color: #00ff88; }
        .badge-vix { background: rgba(255,165,2,0.2); color: #ffa502; }
        .badge-error { background: rgba(255,71,87,0.2); color: #ff4757; }
        .pulse-dot { width: 6px; height: 6px; background: #00ff88; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.3); } }
        .quick-actions { display: flex; gap: 8px; overflow-x: auto; padding: 8px 0; -webkit-overflow-scrolling: touch; }
        .quick-actions::-webkit-scrollbar { display: none; }
        .action-btn { padding: 8px 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; color: #e1e4e8; font-size: 13px; font-weight: 600; white-space: nowrap; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
        .action-btn.active { background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%); color: #0a0e27; border-color: transparent; }
        .action-btn:active { transform: scale(0.95); }
        .stats-strip { background: rgba(0,0,0,0.2); padding: 12px 15px; display: flex; gap: 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .stats-strip::-webkit-scrollbar { display: none; }
        .stat-mini { display: flex; flex-direction: column; align-items: center; min-width: 70px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; }
        .stat-mini-value { font-size: 18px; font-weight: 700; margin-bottom: 3px; }
        .stat-mini-label { font-size: 10px; color: #8b92a8; text-transform: uppercase; }
        .stocks-container { padding: 15px; padding-bottom: 80px; }
        .stock-card { background: rgba(255,255,255,0.03); border-radius: 15px; padding: 15px; margin-bottom: 12px; border-left: 4px solid #00ff88; }
        .stock-card.seller-friendly { border-left-color: #00ff88; background: rgba(0,255,136,0.05); }
        .stock-card.caution { border-left-color: #ffa502; background: rgba(255,165,2,0.05); }
        .stock-card.avoid { border-left-color: #ff4757; background: rgba(255,71,87,0.05); }
        .stock-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .stock-name-mobile { font-size: 18px; font-weight: 700; color: #00d4ff; }
        .stock-price-mobile { font-size: 16px; font-weight: 600; }
        .price-change { font-size: 13px; margin-top: 2px; }
        .positive { color: #00ff88; }
        .negative { color: #ff4757; }
        .metrics-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 12px; }
        .metric-box { text-align: center; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 8px; }
        .metric-box-value { font-size: 15px; font-weight: 700; margin-bottom: 3px; }
        .metric-box-label { font-size: 10px; color: #8b92a8; text-transform: uppercase; }
        .oi-badge-mobile { padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: 600; text-transform: uppercase; display: inline-block; margin-bottom: 12px; }
        .long-buildup { background: rgba(0,255,136,0.2); color: #00ff88; }
        .short-buildup { background: rgba(255,71,87,0.2); color: #ff4757; }
        .short-covering { background: rgba(0,212,255,0.2); color: #00d4ff; }
        .long-unwinding { background: rgba(255,165,2,0.2); color: #ffa502; }
        .trade-info { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 10px; }
        .trade-row-mobile { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; }
        .trade-label-mobile { color: #8b92a8; }
        .trade-value-mobile { font-weight: 700; }
        .highlight-value { font-size: 16px; color: #00ff88; }
        .ivp-indicator { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin-top: 4px; }
        .ivp-fill { height: 100%; background: linear-gradient(90deg, #00ff88 0%, #ffa502 50%, #ff4757 100%); transition: width 0.3s; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1f3a; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; padding: 8px 0 max(8px, env(safe-area-inset-bottom)); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px 15px; cursor: pointer; color: #8b92a8; font-size: 11px; font-weight: 600; transition: color 0.3s; position: relative; }
        .nav-item.active { color: #00ff88; }
        .nav-icon { font-size: 22px; }
        .loading-mobile { display: none; text-align: center; padding: 40px 20px; }
        .loading-mobile.show { display: block; }
        .spinner-mobile { width: 40px; height: 40px; border: 3px solid rgba(0,255,136,0.2); border-top-color: #00ff88; border-radius: 50%; margin: 0 auto 15px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .refresh-btn { position: fixed; bottom: 80px; right: 15px; width: 56px; height: 56px; background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%); border-radius: 50%; border: none; color: #0a0e27; font-size: 24px; cursor: pointer; box-shadow: 0 4px 20px rgba(0,255,136,0.4); z-index: 999; display: flex; align-items: center; justify-content: center; transition: transform 0.3s; }
        .refresh-btn:active { transform: scale(0.9) rotate(180deg); }
        .filter-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1f3a; border-radius: 20px 20px 0 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2000; max-height: 80vh; overflow-y: auto; padding-bottom: env(safe-area-inset-bottom); }
        .filter-sheet.show { transform: translateY(0); }
        .sheet-handle { width: 40px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin: 12px auto 15px; }
        .sheet-header { padding: 0 20px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 18px; font-weight: 700; color: #00ff88; }
        .filter-group-mobile { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .filter-label-mobile { font-size: 13px; color: #8b92a8; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .filter-input-mobile { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: #e1e4e8; font-size: 16px; }
        .filter-input-mobile:focus { outline: none; border-color: #00ff88; }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .toggle-switch-mobile { position: relative; width: 50px; height: 30px; background: rgba(255,255,255,0.1); border-radius: 15px; cursor: pointer; transition: background 0.3s; }
        .toggle-switch-mobile.active { background: #00ff88; }
        .toggle-slider-mobile { position: absolute; top: 3px; left: 3px; width: 24px; height: 24px; background: white; border-radius: 50%; transition: transform 0.3s; }
        .toggle-switch-mobile.active .toggle-slider-mobile { transform: translateX(20px); }
        .apply-filters-btn { margin: 20px; padding: 15px; background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%); color: #0a0e27; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; width: calc(100% - 40px); cursor: pointer; }
        .apply-filters-btn:active { transform: scale(0.98); }
        .alerts-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 3000; padding: 20px; overflow-y: auto; }
        .alerts-modal.show { display: block; }
        .modal-header-mobile { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-top: env(safe-area-inset-top); }
        .modal-title { font-size: 22px; font-weight: 700; color: #00ff88; }
        .close-btn { font-size: 30px; color: #8b92a8; cursor: pointer; }
        .alert-card { background: rgba(255,255,255,0.05); border-left: 3px solid #ff4757; border-radius: 10px; padding: 15px; margin-bottom: 12px; }
        .alert-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .alert-stock { font-size: 16px; font-weight: 700; color: #00d4ff; }
        .alert-badge-small { padding: 4px 10px; background: rgba(255,71,87,0.2); color: #ff4757; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .alert-message { font-size: 14px; color: #e1e4e8; }
        .empty-state { text-align: center; padding: 60px 20px; color: #8b92a8; }
        .empty-icon { font-size: 48px; margin-bottom: 15px; }
        .alert-badge-nav { position: absolute; top: 4px; right: 8px; background: #ff4757; color: white; border-radius: 10px; padding: 2px 6px; font-size: 10px; font-weight: 700; }
        .banner { padding: 12px 15px; text-align: center; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .banner-error { background: rgba(255,71,87,0.2); color: #ff4757; }
        .banner-success { background: rgba(0,255,136,0.2); color: #00ff88; }
        .banner-info { background: rgba(0,212,255,0.2); color: #00d4ff; }
        .config-panel { padding: 20px; display: none; }
        .config-panel.show { display: block; }
        .config-input { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e1e4e8; font-size: 14px; margin-bottom: 15px; }
        .config-label { font-size: 13px; color: #8b92a8; margin-bottom: 8px; font-weight: 600; display: block; }
        .btn-primary { padding: 12px 20px; background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%); color: #0a0e27; border: none; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer; width: 100%; margin-bottom: 10px; }
        .btn-secondary { padding: 12px 20px; background: rgba(0,212,255,0.2); color: #00d4ff; border: 1px solid #00d4ff; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer; width: 100%; }
        .data-source-info { background: rgba(0,212,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 3px solid #00d4ff; }
        .setup-guide { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; margin-top: 20px; font-size: 12px; line-height: 1.6; }
        .setup-guide h4 { color: #00ff88; margin-bottom: 10px; }
        .progress-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #00ff88 0%, #00d4ff 100%); transition: width 0.3s; }
        @media (max-width: 375px) { .metrics-row { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div id="bannerContainer"></div>

```
<div class="mobile-header">
    <div class="header-row">
        <div class="app-title">üìä F&O Scanner <span style="font-size: 10px; opacity: 0.7;">v2.0</span></div>
        <div class="status-badge">
            <div class="badge badge-live" id="connectionBadge">
                <div class="pulse-dot"></div>
                <span id="marketStatus">READY</span>
            </div>
            <div class="badge badge-vix">VIX <span id="vixValue">--</span></div>
        </div>
    </div>
    <div class="quick-actions">
        <button class="action-btn active" onclick="setFilter('all')">All (<span id="countAll">0</span>)</button>
        <button class="action-btn" onclick="setFilter('seller')">üü¢ Seller (<span id="countSeller">0</span>)</button>
        <button class="action-btn" onclick="setFilter('caution')">üü° Caution (<span id="countCaution">0</span>)</button>
        <button class="action-btn" onclick="setFilter('avoid')">üî¥ Avoid (<span id="countAvoid">0</span>)</button>
    </div>
</div>

<div class="stats-strip">
    <div class="stat-mini"><div class="stat-mini-value" id="statNifty">--</div><div class="stat-mini-label">Nifty</div></div>
    <div class="stat-mini"><div class="stat-mini-value" id="statStocks">0</div><div class="stat-mini-label">Stocks</div></div>
    <div class="stat-mini"><div class="stat-mini-value" id="statAvgROC">0%</div><div class="stat-mini-label">Avg ROC</div></div>
    <div class="stat-mini"><div class="stat-mini-value" id="statHighIVP">0</div><div class="stat-mini-label">High IVP</div></div>
</div>

<div class="stocks-container" id="stocksContainer">
    <div class="empty-state">
        <div class="empty-icon">üöÄ</div>
        <h3>Welcome to F&O Scanner</h3>
        <p>Configure your Angel SmartAPI in the API tab, then refresh to load data</p>
    </div>
</div>

<button class="refresh-btn" onclick="refreshData()" title="Refresh Data">üîÑ</button>

<div class="filter-sheet" id="filterSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">Filter Settings</div>
    <div class="filter-group-mobile"><div class="filter-label-mobile"><span>Min IVP (%)</span><span id="ivpValue">75</span></div><input type="range" class="filter-input-mobile" id="filterIVP" min="0" max="100" value="75" oninput="document.getElementById('ivpValue').textContent = this.value"></div>
    <div class="filter-group-mobile"><div class="filter-label-mobile"><span>PCR Min</span><span id="pcrMinValue">0.80</span></div><input type="range" class="filter-input-mobile" id="filterPCRMin" min="0" max="2" step="0.1" value="0.8" oninput="document.getElementById('pcrMinValue').textContent = parseFloat(this.value).toFixed(2)"></div>
    <div class="filter-group-mobile"><div class="filter-label-mobile"><span>PCR Max</span><span id="pcrMaxValue">1.40</span></div><input type="range" class="filter-input-mobile" id="filterPCRMax" min="0" max="3" step="0.1" value="1.4" oninput="document.getElementById('pcrMaxValue').textContent = parseFloat(this.value).toFixed(2)"></div>
    <div class="filter-group-mobile"><div class="filter-label-mobile"><span>Min ROC (%)</span><span id="rocValue">0</span></div><input type="range" class="filter-input-mobile" id="filterROC" min="0" max="30" step="0.5" value="0" oninput="document.getElementById('rocValue').textContent = this.value"></div>
    <div class="filter-group-mobile"><div class="filter-label-mobile"><span>Min BE Distance (%)</span><span id="beValue">0</span></div><input type="range" class="filter-input-mobile" id="filterBE" min="0" max="20" step="0.5" value="0" oninput="document.getElementById('beValue').textContent = this.value"></div>
    <div class="toggle-row"><div><div style="font-weight: 600; margin-bottom: 3px;">Positive OI Only</div><div style="font-size: 12px; color: #8b92a8;">Show only bullish OI build-up</div></div><div class="toggle-switch-mobile active" id="toggleOI" onclick="toggleSetting('oi')"><div class="toggle-slider-mobile"></div></div></div>
    <div class="toggle-row"><div><div style="font-weight: 600; margin-bottom: 3px;">Exclude Results</div><div style="font-size: 12px; color: #8b92a8;">Hide stocks with earnings in 3 days</div></div><div class="toggle-switch-mobile active" id="toggleResults" onclick="toggleSetting('results')"><div class="toggle-slider-mobile"></div></div></div>
    <button class="apply-filters-btn" onclick="applyFilters()">Apply Filters</button>
</div>

<div class="alerts-modal" id="alertsModal">
    <div class="modal-header-mobile"><div class="modal-title">üîî Active Alerts</div><div class="close-btn" onclick="closeAlerts()">√ó</div></div>
    <div id="alertsList"></div>
</div>

<div class="config-panel" id="configPanel">
    <div class="data-source-info">
        <div style="font-weight: 700; margin-bottom: 10px; color: #00d4ff;">üì° Angel One SmartAPI Configuration</div>
        <div style="font-size: 13px; line-height: 1.6;">
            Connect your Angel One account for FREE real-time NSE F&O data. Your credentials are stored securely on your device only.
        </div>
    </div>
    
    <label class="config-label">Backend URL <span style="color: #ff4757;">*</span></label>
    <input type="text" class="config-input" id="backendUrl" placeholder="https://your-backend.onrender.com" value="">
    
    <label class="config-label">API Key <span style="color: #ff4757;">*</span></label>
    <input type="text" class="config-input" id="apiKey" placeholder="Get from smartapi.angelbroking.com" value="">
    
    <label class="config-label">Client ID <span style="color: #ff4757;">*</span></label>
    <input type="text" class="config-input" id="clientId" placeholder="Your Angel One client code (e.g., M123456)" value="">
    
    <label class="config-label">Password <span style="color: #ff4757;">*</span></label>
    <input type="password" class="config-input" id="password" placeholder="Your Angel One login password" value="">
    
    <label class="config-label">PIN (MPIN) <span style="color: #ff4757;">*</span></label>
    <input type="password" class="config-input" id="pin" placeholder="Your 4 or 6 digit trading PIN" maxlength="6" value="">
    
    <label class="config-label">TOTP Token (From Google Authenticator)</label>
    <input type="text" class="config-input" id="totpToken" placeholder="6-digit code from authenticator app" maxlength="6" value="">
    
    <button class="btn-primary" onclick="saveAndConnect()">üíæ Save & Connect</button>
    <button class="btn-secondary" onclick="testBackend()">üîó Test Backend</button>
    
    <div class="setup-guide">
        <h4>üìö Quick Setup Guide:</h4>
        <ol style="margin-left: 20px; line-height: 1.8;">
            <li><strong>Deploy Backend First:</strong> Use the angel_backend.py file on Render.com (FREE)</li>
            <li><strong>Get Backend URL:</strong> Copy your Render app URL (e.g., https://your-app.onrender.com)</li>
            <li><strong>Angel SmartAPI:</strong> Go to smartapi.angelbroking.com ‚Üí Create App ‚Üí Get API Key</li>
            <li><strong>Client ID:</strong> Your Angel One trading client code (starts with M, A, etc.)</li>
            <li><strong>Password:</strong> Same password you use to login to Angel One app</li>
            <li><strong>PIN:</strong> Your trading PIN (MPIN) - 4 or 6 digits</li>
            <li><strong>TOTP:</strong> Open Google Authenticator ‚Üí Enter the 6-digit code</li>
            <li><strong>Save:</strong> Click "Save & Connect" to authenticate</li>
            <li><strong>Refresh:</strong> Go to Stocks tab ‚Üí Click refresh to load data!</li>
        </ol>
    </div>
    
    <div style="margin-top: 20px; padding: 15px; background: rgba(0,255,136,0.1); border-radius: 10px; font-size: 12px; color: #00ff88; line-height: 1.6;">
        <strong>‚úÖ What You Get:</strong>
        <ul style="margin: 10px 0 0 20px;">
            <li>Real-time live quotes</li>
            <li>All NSE F&O stocks</li>
            <li>Option chain data</li>
            <li>100% FREE - No API charges</li>
            <li>Auto-refresh every 5 minutes</li>
        </ul>
    </div>
    
    <div style="margin-top: 15px; padding: 15px; background: rgba(255,165,2,0.1); border-radius: 10px; font-size: 12px; color: #ffa502; line-height: 1.6;">
        <strong>üîí Security:</strong> Your credentials are stored locally on your device and sent only to YOUR backend server and Angel One API.
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item" onclick="showTab('stocks')" id="navStocks"><div class="nav-icon">üìä</div><div>Stocks</div></div>
    <div class="nav-item" onclick="showTab('filter')" id="navFilter"><div class="nav-icon">‚öôÔ∏è</div><div>Filters</div></div>
    <div class="nav-item" onclick="showTab('alerts')" id="navAlerts"><div class="nav-icon">üîî</div><div>Alerts</div><div class="alert-badge-nav" id="alertBadgeNav" style="display: none;">0</div></div>
    <div class="nav-item active" onclick="showTab('config')" id="navConfig"><div class="nav-icon">üîß</div><div>API</div></div>
</div>

<script>
    // ========== CONFIGURATION ==========
    const FO_STOCKS = ['RELIANCE','TCS','HDFCBANK','INFY','ICICIBANK','HINDUNILVR','SBIN','BHARTIARTL','BAJFINANCE','KOTAKBANK','LT','AXISBANK','ITC','ASIANPAINT','MARUTI','TITAN','SUNPHARMA','ULTRACEMCO','NESTLEIND','TATAMOTORS','TATASTEEL','POWERGRID','NTPC','ONGC','HCLTECH','WIPRO','TECHM','INDUSINDBK','BAJAJFINSV','GRASIM','DRREDDY','DIVISLAB','CIPLA','EICHERMOT','HEROMOTOCO','ADANIPORTS','COALINDIA','JSWSTEEL','TATACONSUM','BRITANNIA','APOLLOHOSP','HINDALCO','SHREECEM','VEDL','ADANIENT','MANAPPURAM','SAIL','NMDC','BANKBARODA','PNB','CANBK'];
    
    let stockData = [];
    let filteredData = [];
    let alerts = [];
    let currentFilter = 'all';
    let sortColumn = 'ivp';
    let filterSettings = { ivp: 75, pcrMin: 0.8, pcrMax: 1.4, roc: 0, be: 0, positiveOI: true, excludeResults: true };
    let autoRefreshInterval = null;
    let isDataLoading = false;
    let isAuthenticated = false;
    let authToken = null;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 3;
    
    // ========== INITIALIZATION ==========
    window.addEventListener('load', () => {
        loadSavedConfig();
        updateMarketStatus();
        setInterval(updateMarketStatus, 60000);
    });
    
    function loadSavedConfig() {
        document.getElementById('backendUrl').value = localStorage.getItem('backendUrl') || '';
        document.getElementById('apiKey').value = localStorage.getItem('apiKey') || '';
        document.getElementById('clientId').value = localStorage.getItem('clientId') || '';
        authToken = localStorage.getItem('authToken') || null;
        
        if (authToken) {
            isAuthenticated = true;
            updateStatus('Authenticated', 'live');
            showBanner('‚úÖ Using saved session. Click refresh to load data.', 'success');
        }
    }
    
    async function saveAndConnect() {
        const backendUrl = document.getElementById('backendUrl').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        const clientId = document.getElementById('clientId').value.trim();
        const password = document.getElementById('password').value.trim();
        const pin = document.getElementById('pin').value.trim();
        const totpToken = document.getElementById('totpToken').value.trim();
        
        if (!backendUrl || !apiKey || !clientId || !password || !pin) {
            showBanner('‚ùå Please fill all required fields (marked with *)', 'error');
            return;
        }
        
        localStorage.setItem('backendUrl', backendUrl);
        localStorage.setItem('apiKey', apiKey);
        localStorage.setItem('clientId', clientId);
        
        showBanner('üîê Authenticating with Angel SmartAPI...', 'info');
        updateStatus('Connecting...', 'connecting');
        
        try {
            const response = await fetch(`${backendUrl}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    apiKey: apiKey,
                    clientId: clientId,
                    password: password,
                    pin: pin,
                    totpToken: totpToken
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                authToken = data.jwtToken;
                localStorage.setItem('authToken', authToken);
                isAuthenticated = true;
                reconnectAttempts = 0;
                
                showBanner('‚úÖ Successfully connected to Angel SmartAPI!', 'success');
                updateStatus('Connected', 'live');
                
                document.getElementById('password').value = '';
                document.getElementById('pin').value = '';
                document.getElementById('totpToken').value = '';
                
                setTimeout(() => {
                    showBanner('üìä Go to Stocks tab and click refresh to load data!', 'info');
                }, 2000);
            } else {
                throw new Error(data.message || 'Authentication failed');
            }
        } catch (error) {
            showBanner('‚ùå Connection failed: ' + error.message, 'error');
            updateStatus('Error', 'error');
            isAuthenticated = false;
            authToken = null;
        }
    }
    
    async function testBackend() {
        const backendUrl = document.getElementById('backendUrl').value.trim();
        
        if (!backendUrl) {
            showBanner('‚ùå Please enter backend URL first', 'error');
            return;
        }
        
        showBanner('üîç Testing backend connection...', 'info');
        
        try {
            const response = await fetch(`${backendUrl}/health`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (response.ok) {
                const data = await response.json();
                showBanner(`‚úÖ Backend is online! Status: ${data.status}`, 'success');
            } else {
                throw new Error('Backend returned error');
            }
        } catch (error) {
            showBanner('‚ùå Backend not reachable. Check URL and deploy status.', 'error');
        }
    }
    
    async function loadData() {
        if (isDataLoading) return;
        
        if (!isAuthenticated || !authToken) {
            showBanner('‚ö†Ô∏è Please configure and authenticate in API tab first', 'error');
            stockData = generateDemoData();
            applyFilters();
            return;
        }
        
        isDataLoading = true;
        showLoading();
        updateStatus('Loading data...', 'connecting');
        
        const backendUrl = localStorage.getItem('backendUrl');
        const clientId = localStorage.getItem('clientId');
        
        try {
            showBanner('üì° Fetching live data from Angel SmartAPI...', 'info');
            
            const batchSize = 10;
            const allData = [];
            let processed = 0;
            
            for (let i = 0; i < FO_STOCKS.length; i += batchSize) {
                const batch = FO_STOCKS.slice(i, i + batchSize);
                updateProgress((i / FO_STOCKS.length) * 100);
                
                const symbols = batch.join(',');
                const response = await fetch(`${backendUrl}/quotes?clientId=${clientId}&symbols=${symbols}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.status === 401) {
                    throw new Error('Session expired. Please re-authenticate.');
                }
                
                const data = await response.json();
                
                if (data.success && data.quotes) {
                    allData.push(...data.quotes.map(q => processQuoteData(q)));
                    processed += batch.length;
                    showBanner(`üìä Loaded ${processed}/${FO_STOCKS.length} stocks...`, 'info');
                }
                
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            if (allData.length > 0) {
                stockData = allData;
                showBanner(`‚úÖ Loaded ${allData.length} stocks successfully!`, 'success');
                updateStatus('Live', 'live');
                reconnectAttempts = 0;
            } else {
                throw new Error('No data received');
            }
            
        } catch (error) {
            console.error('Load error:', error);
            
            if (error.message.includes('expired') && reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                showBanner(`üîÑ Session expired. Attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS} to reconnect...`, 'info');
                
                isAuthenticated = false;
                authToken = null;
                localStorage.removeItem('authToken');
                
                setTimeout(() => {
                    showTab('config');
                    showBanner('‚ö†Ô∏è Please re-authenticate to continue', 'error');
                }, 2000);
            } else {
                showBanner('‚ö†Ô∏è Using demo data. Check API configuration.', 'error');
                updateStatus('Demo Mode', 'error');
                stockData = generateDemoData();
            }
        }
        
        updateProgress(100);
        applyFilters();
        checkAlerts();
        hideLoading();
        isDataLoading = false;
    }
    
    function processQuoteData(quote) {
        const cmp = parseFloat(quote.ltp) || 0;
        const change = parseFloat(quote.pChange) || 0;
        const lotSize = getLotSize(quote.symbol);
        const iv = parseFloat(quote.impliedVolatility) || (Math.random() * 50 + 20);
        const ivp = Math.min(100, (iv / 50) * 100);
        const pcr = parseFloat(quote.pcr) || (Math.random() * 1.5 + 0.5);
        
        const futOIChange = parseFloat(quote.oiChange) || ((Math.random() - 0.3) * 30);
        const futPriceChange = change;
        
        let oiType = '';
        if (futOIChange > 0 && futPriceChange > 0) oiType = 'long-buildup';
        else if (futOIChange > 0 && futPriceChange < 0) oiType = 'short-buildup';
        else if (futOIChange < 0 && futPriceChange > 0) oiType = 'short-covering';
        else oiType = 'long-unwinding';
        
        const strikePrice = Math.round(cmp * 0.9 / 5) * 5;
        const premium = (cmp * 0.005 * (iv / 30)).toFixed(2);
        const margin = Math.round(strikePrice * lotSize * 0.15);
        const roc = ((premium * lotSize) / margin * 100).toFixed(2);
        const breakEven = strikePrice - premium;
        const beDistance = ((cmp - breakEven) / cmp * 100).toFixed(2);
        
        return {
            stock: quote.symbol,
            cmp: cmp.toFixed(2),
            change: change.toFixed(2),
            lotSize,
            iv: iv.toFixed(2),
            ivp: ivp.toFixed(2),
            pcr: pcr.toFixed(2),
            futOIChange: futOIChange.toFixed(2),
            futPriceChange: futPriceChange.toFixed(2),
            oiType,
            strikePrice,
            premium,
            margin,
            roc,
            breakEven: breakEven.toFixed(2),
            beDistance,
            hasResults: false,
            timestamp: new Date()
        };
    }
    
    function generateDemoData() {
        return FO_STOCKS.map(stock => {
            const cmp = Math.random() * 3000 + 100;
            const change = (Math.random() - 0.5) * 6;
            const lotSize = getLotSize(stock);
            const iv = Math.random() * 70 + 20;
            const ivp = Math.random() * 100;
            const pcr = Math.random() * 1.5 + 0.5;
            const futOIChange = (Math.random() - 0.3) * 30;
            const futPriceChange = (Math.random() - 0.5) * 4;
            
            let oiType = '';
            if (futOIChange > 0 && futPriceChange > 0) oiType = 'long-buildup';
            else if (futOIChange > 0 && futPriceChange < 0) oiType = 'short-buildup';
            else if (futOIChange < 0 && futPriceChange > 0) oiType = 'short-covering';
            else oiType = 'long-unwinding';
            
            const strikePrice = Math.round(cmp * 0.9 / 5) * 5;
            const premium = (cmp * 0.005 * (iv / 30)).toFixed(2);
            const margin = Math.round(strikePrice * lotSize * 0.15);
            const roc = ((premium * lotSize) / margin * 100).toFixed(2);
            const breakEven = strikePrice - premium;
            const beDistance = ((cmp - breakEven) / cmp * 100).toFixed(2);
            
            return {
                stock, cmp: cmp.toFixed(2), change: change.toFixed(2), lotSize,
                iv: iv.toFixed(2), ivp: ivp.toFixed(2), pcr: pcr.toFixed(2),
                futOIChange: futOIChange.toFixed(2), futPriceChange: futPriceChange.toFixed(2),
                oiType, strikePrice, premium, margin, roc,
                breakEven: breakEven.toFixed(2), beDistance,
                hasResults: Math.random() < 0.1, timestamp: new Date()
            };
        });
    }
    
    function getLotSize(symbol) {
        const lots = {'RELIANCE':250,'TCS':150,'HDFCBANK':550,'INFY':300,'ICICIBANK':1375,'SBIN':1500,'BAJFINANCE':125,'MARUTI':100,'TATAMOTORS':1500,'TATASTEEL':1650,'MANAPPURAM':3000};
        return lots[symbol] || Math.floor(Math.random() * 2000) + 500;
    }
    
    // ========== UI FUNCTIONS ==========
    function showBanner(message, type) {
        const container = document.getElementById('bannerContainer');
        const className = `banner banner-${type}`;
        container.innerHTML = `<div class="${className}">${message}</div>`;
        setTimeout(() => { container.innerHTML = ''; }, 5000);
    }
    
    function updateStatus(message, type) {
        const badge = document.getElementById('connectionBadge');
        const status = document.getElementById('marketStatus');
        status.textContent = message;
        badge.className = 'badge';
        if (type === 'live') badge.classList.add('badge-live');
        else if (type === 'error') badge.classList.add('badge-error');
        else badge.classList.add('badge-vix');
    }
    
    function updateProgress(percent) {
        // Could add progress bar UI here if needed
        console.log(`Progress: ${percent.toFixed(0)}%`);
    }
    
    function refreshData() { loadData(); }
    
    function applyFilters() {
        filterSettings.ivp = parseFloat(document.getElementById('filterIVP').value);
        filterSettings.pcrMin = parseFloat(document.getElementById('filterPCRMin').value);
        filterSettings.pcrMax = parseFloat(document.getElementById('filterPCRMax').value);
        filterSettings.roc = parseFloat(document.getElementById('filterROC').value);
        filterSettings.be = parseFloat(document.getElementById('filterBE').value);
        
        filteredData = stockData.filter(stock => {
            if (parseFloat(stock.ivp) < filterSettings.ivp) return false;
            if (parseFloat(stock.pcr) < filterSettings.pcrMin || parseFloat(stock.pcr) > filterSettings.pcrMax) return false;
            if (parseFloat(stock.roc) < filterSettings.roc) return false;
            if (parseFloat(stock.beDistance) < filterSettings.be) return false;
            if (filterSettings.positiveOI && parseFloat(stock.futOIChange) < 0) return false;
            if (filterSettings.excludeResults && stock.hasResults) return false;
            return true;
        });
        
        renderStocks();
        updateStats();
        closeFilterSheet();
    }
    
    function toggleSetting(type) {
        if (type === 'oi') {
            const toggle = document.getElementById('toggleOI');
            toggle.classList.toggle('active');
            filterSettings.positiveOI = toggle.classList.contains('active');
        } else if (type === 'results') {
            const toggle = document.getElementById('toggleResults');
            toggle.classList.toggle('active');
            filterSettings.excludeResults = toggle.classList.contains('active');
        }
    }
    
    function classifyStock(stock) {
        const ivp = parseFloat(stock.ivp);
        const roc = parseFloat(stock.roc);
        const be = parseFloat(stock.beDistance);
        const pcr = parseFloat(stock.pcr);
        const oiPositive = parseFloat(stock.futOIChange) > 0;
        
        if (ivp >= 75 && roc >= 8 && be >= 8 && pcr >= 0.8 && pcr <= 1.3 && oiPositive) return 'seller-friendly';
        else if (ivp < 50 || be < 5 || roc < 3) return 'avoid';
        return 'caution';
    }
    
    function renderStocks() {
        const container = document.getElementById('stocksContainer');
        let displayData = filteredData;
        
        if (currentFilter !== 'all') {
            displayData = filteredData.filter(stock => {
                const classification = classifyStock(stock);
                if (currentFilter === 'seller') return classification === 'seller-friendly';
                if (currentFilter === 'caution') return classification === 'caution';
                if (currentFilter === 'avoid') return classification === 'avoid';
                return true;
            });
        }
        
        displayData = [...displayData].sort((a, b) => {
            const aVal = parseFloat(a[sortColumn]) || a[sortColumn];
            const bVal = parseFloat(b[sortColumn]) || b[sortColumn];
            return aVal < bVal ? 1 : -1;
        });
        
        if (displayData.length === 0) {
            container.innerHTML = `<div class="empty-state"><div class="empty-icon">üì≠</div><h3>No stocks found</h3><p>Try adjusting your filters</p></div>`;
            return;
        }
        
        container.innerHTML = displayData.map(stock => {
            const classification = classifyStock(stock);
            const changeClass = parseFloat(stock.change) >= 0 ? 'positive' : 'negative';
            return `<div class="stock-card ${classification}"><div class="stock-header"><div><div class="stock-name-mobile">${stock.stock}</div><div class="oi-badge-mobile ${stock.oiType}">${stock.oiType.replace('-', ' ')}</div></div><div style="text-align: right;"><div class="stock-price-mobile">‚Çπ${parseFloat(stock.cmp).toFixed(2)}</div><div class="price-change ${changeClass}">${stock.change}%</div></div></div><div class="metrics-row"><div class="metric-box"><div class="metric-box-value">${stock.iv}%</div><div class="metric-box-label">IV</div></div><div class="metric-box"><div class="metric-box-value">${stock.ivp}%</div><div class="metric-box-label">IVP</div><div class="ivp-indicator"><div class="ivp-fill" style="width: ${stock.ivp}%"></div></div></div><div class="metric-box"><div class="metric-box-value">${stock.pcr}</div><div class="metric-box-label">PCR</div></div><div class="metric-box"><div class="metric-box-value">${stock.lotSize}</div><div class="metric-box-label">Lot</div></div></div><div class="trade-info"><div class="trade-row-mobile"><span class="trade-label-mobile">10% OTM Strike</span><span class="trade-value-mobile">‚Çπ${stock.strikePrice} PUT</span></div><div class="trade-row-mobile"><span class="trade-label-mobile">Premium</span><span class="trade-value-mobile">‚Çπ${stock.premium}</span></div><div class="trade-row-mobile"><span class="trade-label-mobile">Margin (1 lot)</span><span class="trade-value-mobile">‚Çπ${parseInt(stock.margin).toLocaleString()}</span></div><div class="trade-row-mobile" style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 8px; padding-top: 8px;"><span class="trade-label-mobile">ROC</span><span class="trade-value-mobile highlight-value">${stock.roc}%</span></div><div class="trade-row-mobile"><span class="trade-label-mobile">BE Distance</span><span class="trade-value-mobile highlight-value">${stock.beDistance}%</span></div></div></div>`;
        }).join('');
    }
    
    function updateStats() {
        const seller = filteredData.filter(s => classifyStock(s) === 'seller-friendly').length;
        const caution = filteredData.filter(s => classifyStock(s) === 'caution').length;
        const avoid = filteredData.filter(s => classifyStock(s) === 'avoid').length;
        const sellerStocks = filteredData.filter(s => classifyStock(s) === 'seller-friendly');
        const avgROC = sellerStocks.length > 0 ? (sellerStocks.reduce((sum, s) => sum + parseFloat(s.roc), 0) / sellerStocks.length).toFixed(2) : 0;
        const highIVP = filteredData.filter(s => parseFloat(s.ivp) > 75).length;
        
        document.getElementById('countAll').textContent = filteredData.length;
        document.getElementById('countSeller').textContent = seller;
        document.getElementById('countCaution').textContent = caution;
        document.getElementById('countAvoid').textContent = avoid;
        document.getElementById('statStocks').textContent = filteredData.length;
        document.getElementById('statAvgROC').textContent = avgROC + '%';
        document.getElementById('statHighIVP').textContent = highIVP;
        if (stockData.length > 0) document.getElementById('statNifty').textContent = '25,471';
    }
    
    function checkAlerts() {
        alerts = [];
        stockData.forEach(stock => {
            if (parseFloat(stock.ivp) >= 85) alerts.push({ type: 'IVP Alert', stock: stock.stock, message: `IVP at ${stock.ivp}% (crossed 85%)`, severity: 'high' });
            if (parseFloat(stock.beDistance) < 5 && parseFloat(stock.beDistance) > 0) alerts.push({ type: 'BE Warning', stock: stock.stock, message: `Break-even only ${stock.beDistance}% away`, severity: 'critical' });
        });
        const badge = document.getElementById('alertBadgeNav');
        badge.textContent = alerts.length;
        badge.style.display = alerts.length > 0 ? 'flex' : 'none';
    }
    
    function showAlerts() {
        const modal = document.getElementById('alertsModal');
        const alertsList = document.getElementById('alertsList');
        if (alerts.length === 0) {
            alertsList.innerHTML = `<div class="empty-state"><div class="empty-icon">üîï</div><h3>No active alerts</h3><p>You'll be notified when conditions are met</p></div>`;
        } else {
            alertsList.innerHTML = alerts.map(alert => `<div class="alert-card"><div class="alert-header"><div class="alert-stock">${alert.stock}</div><div class="alert-badge-small">${alert.type}</div></div><div class="alert-message">${alert.message}</div></div>`).join('');
        }
        modal.classList.add('show');
    }
    
    function closeAlerts() { document.getElementById('alertsModal').classList.remove('show'); }
    
    function showTab(tab) {
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        document.getElementById('stocksContainer').style.display = 'none';
        document.getElementById('configPanel').classList.remove('show');
        closeFilterSheet();
        closeAlerts();
        
        if (tab === 'stocks') {
            document.getElementById('navStocks').classList.add('active');
            document.getElementById('stocksContainer').style.display = 'block';
        } else if (tab === 'filter') {
            document.getElementById('navFilter').classList.add('active');
            document.getElementById('filterSheet').classList.add('show');
        } else if (tab === 'alerts') {
            document.getElementById('navAlerts').classList.add('active');
            showAlerts();
        } else if (tab === 'config') {
            document.getElementById('navConfig').classList.add('active');
            document.getElementById('configPanel').classList.add('show');
        }
    }
    
    function closeFilterSheet() { document.getElementById('filterSheet').classList.remove('show'); }
    function setFilter(filter) {
        currentFilter = filter;
        document.querySelectorAll('.quick-actions .action-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        renderStocks();
    }
    function updateMarketStatus() {
        const now = new Date();
        const hours = now.getHours();
        const day = now.getDay();
        const marketOpen = (day >= 1 && day <= 5) && ((hours === 9) || (hours > 9 && hours < 15) || (hours === 15));
    }
    function showLoading() { const loading = document.querySelector('.loading-mobile'); if (loading) loading.classList.add('show'); }
    function hideLoading() { const loading = document.querySelector('.loading-mobile'); if (loading) loading.classList.remove('show'); }
    
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (event) => {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) event.preventDefault();
        lastTouchEnd = now;
    }, false);
</script>
```

</body>
</html>
